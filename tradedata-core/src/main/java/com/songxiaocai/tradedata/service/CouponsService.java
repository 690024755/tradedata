package com.songxiaocai.tradedata.service;/* * Description:com.songxiaocai.tradedata.service * @Date Create on 18:18 * @author <a href="mailto:yangyi@songxiaocai.com">yangyi</a> * @Version JDK 1.8 * @since version 1.0 Copyright 2019-02-25日SXC All Rights Reserved. */import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONObject;import com.songxiaocai.tradedata.application.repository.SxcUserRepository;import com.songxiaocai.tradedata.service.params.SxcUserInfoDTO;import com.songxiaocai.tradedata.tool.date.DateTool;import com.songxiaocai.tradedata.tool.http.HttpRequestSimple;import com.songxiaocai.tradedata.tool.jedis.JedisTemplate;import com.songxiaocai.tradedata.tool.map.MapUtil;import com.sxc.common.domain.result.Result;import com.sxc.midgard.activitydubbo.constant.enums.CouponRangeTypeEnum;import com.sxc.midgard.activitydubbo.params.coupon.CouponDTO;import com.sxc.midgard.activitydubbo.params.coupon.GiveOutDTO;import com.sxc.midgard.activitydubbo.params.coupon.OrderInfoDTO;import lombok.extern.slf4j.Slf4j;import org.apache.commons.lang3.StringUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;import org.springframework.stereotype.Service;import java.util.*;@Service@Slf4jpublic class CouponsService {	Integer SESSION_MAX_AGE = 60 * 60 * 24 * 30;	@Autowired	private HttpRequestSimple httpclent;	@Autowired	private JedisTemplate jedisTemplate;	@Autowired	private SxcUserRepository sxcUserRepository;	/*	给用户发放代金券	 */	public Result<String> sendCoupons(String mobile,Integer couponType,Integer durationTime,String cat,String goodsGroup){		Result<String> re=new Result<>();		Map<String,Object> hashmap=new HashMap<>();		String response=null;		HashMap<String, Object> hs =new HashMap<String, Object>();		hs.put("mobilePhone",mobile);		hs.put("userType",1);		SxcUserInfoDTO sxcUserInfoDTO=sxcUserRepository.getByMobilePhone(hs);		Integer userId=null;		if(sxcUserInfoDTO!=null ){			 userId=sxcUserInfoDTO.getUserId();		}else{			re.setSuccess(false);			re.setErrorMessage("查询不到用户信息");			return re;		}		CouponDTO couponDTO=new CouponDTO();		try{			if(couponType.equals(CouponRangeTypeEnum.ALL.getId())){				couponDTO.setCatIdArray(cat);				//商品分组类				couponDTO.setGoodsGroupIds(goodsGroup);			}else if(couponType.equals(CouponRangeTypeEnum.CAT.getId())){				couponDTO.setCatIdArray(cat);				couponDTO.setGoodsGroupIds("[]");			} else if(couponType.equals(CouponRangeTypeEnum.GOODS_GROUP.getId())){				//商品分组类				couponDTO.setGoodsGroupIds(goodsGroup);				couponDTO.setCatIdArray("[]");			}else {				re.setSuccess(false);				re.setErrorMessage("输入的代金券类型不正确");				return re;			}			//代金券有效时间			couponDTO.setBeginTimeStr(DateTool.getCurrentTime());			//代金券有效时间			couponDTO.setEndTimeStr(DateTool.getCurrentDayEndTime());			//折扣力度：10%（可抵扣最高金额=订单金额*（1-抵扣力度））			couponDTO.setDurationTime(durationTime);			//代金券面额			couponDTO.setFee(10000L);            //归属品类			couponDTO.setAttachCat(152);			//可用品类			//代金券类型			couponDTO.setUseType(0);			//代金券发放原因			couponDTO.setDescription("测试");			//小b用户的userid			couponDTO.setUserId(userId);			GiveOutDTO giveOutDTO=new GiveOutDTO();			giveOutDTO.setCouponDTO(couponDTO);			List<OrderInfoDTO> orderInfos=new ArrayList<>();			giveOutDTO.setOrderInfos(orderInfos);			hashmap.put("giveOutDTO",JSON.toJSONString(giveOutDTO));			hashmap.put("appKey","18701298");			hashmap.put("clientSysName","pcweb");			hashmap.put("clientSysVersion","1.0.0");			hashmap.put("clientVersion","1.0.0");			hashmap.put("deviceUUID","af9947469f3ec84f5308c223ad706a0a");			String cookie="SESSION=".concat(String.valueOf(jedisTemplate.get(getCookie())));			log.info("代金券发放请求报文:" + MapUtil.mapToRequestBody(hashmap));			String url="https://gateway.songxiaocai.net/gw/api/songxiaocai.activity.coupon.giveout";			response = httpclent.postSendHttpApi(url,cookie,MapUtil.mapToRequestBody(hashmap));			log.info("代金券发放返回报文:" + response);		}catch (Exception e){			log.error("代金券发放返回报文: {}", MapUtil.mapToRequestBody(hashmap), e);			re.setSuccess(false);			re.setErrorMessage("发放代金券失败");			return re;		}		re.setData(response);		re.setSuccess(true);        return re;	}	public String getCookie(){		StringBuffer redis_key=null;		Map<String,String> hashmap=new HashMap<String,String>();		try {			hashmap.put("appKey", "18701298");			hashmap.put("bizCode", "erp_login");			hashmap.put("deviceUUID", "9a6c608fbc1f488edd7a14e9488397c5");			hashmap.put("mobilePhone", "19900000111");			hashmap.put("password", "12345");			String url = "https://gateway.songxiaocai.net/login/login";			HttpRequestSimple httpclent = new HttpRequestSimple();			log.info("登录请求报文:" + JSON.toJSONString(hashmap));			String resJson_login = httpclent.postSendHttpWeb(url, JSON.toJSONString(hashmap));			log.info("登录返回报文:" + resJson_login);			String sessionId = JSONObject.parseObject(resJson_login).getJSONObject("result").getString("sessionId");			redis_key = new StringBuffer("18888888888").append("-").append("18701298").append("-").append("erp_login");			jedisTemplate.set(redis_key.toString(), sessionId, SESSION_MAX_AGE);		}catch (Exception e){			log.info("获取登录session失败");		}		return redis_key.toString();	}}